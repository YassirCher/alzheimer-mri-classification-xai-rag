{% extends "base.html" %}

{% block content %}
<div class="main-content bg-gray-50 min-h-screen">
    <!-- Hero Section -->
    <div class="gradient-header text-white py-16 px-4">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-5xl font-bold mb-4 flex items-center justify-center gap-3">
                <i class="fas fa-brain"></i>
                Alzheimer's Disease Classifier
            </h1>
            <p class="text-xl text-gray-100">99.98% Accuracy | Deep Learning Medical AI</p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-12">
        <!-- Model Performance Section -->
        <section id="stats" class="mb-12">
            <h2 class="text-3xl font-bold mb-8 text-gray-800 flex items-center gap-2">
                <i class="fas fa-chart-bar text-purple-600"></i>
                Model Performance
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Overall Accuracy</p>
                            <p class="text-4xl font-bold text-blue-600 mt-2">{{ stats.accuracy }}</p>
                        </div>
                        <i class="fas fa-bullseye text-4xl text-blue-300"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Macro F1-Score</p>
                            <p class="text-4xl font-bold text-green-600 mt-2">{{ stats.macro_f1 }}</p>
                        </div>
                        <i class="fas fa-check-double text-4xl text-green-300"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Cohen's Kappa</p>
                            <p class="text-4xl font-bold text-purple-600 mt-2">{{ stats.cohen_kappa }}</p>
                        </div>
                        <i class="fas fa-handshake text-4xl text-purple-300"></i>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-orange-500 hover:shadow-lg transition">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm font-semibold uppercase tracking-wide">Test Samples</p>
                            <p class="text-4xl font-bold text-orange-600 mt-2">{{ stats.total_test_samples }}</p>
                        </div>
                        <i class="fas fa-images text-4xl text-orange-300"></i>
                    </div>
                </div>
            </div>

            <!-- Per-Class Performance Table -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-blue-50 border-b">
                    <h3 class="text-xl font-bold text-gray-900">Per-Class Performance</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">Class</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">Precision</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">Recall</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">F1-Score</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">Support</th>
                                <th class="px-6 py-3 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">AUC</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for class_name, metrics_data in metrics.per_class_metrics.items() %}
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 font-semibold text-gray-900">{{ class_name }}</td>
                                <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">{{ "%.4f"|format(metrics_data.precision) }}</span></td>
                                <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">{{ "%.4f"|format(metrics_data.recall) }}</span></td>
                                <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">{{ "%.4f"|format(metrics_data.f1) }}</span></td>
                                <td class="px-6 py-4 text-center font-bold text-gray-900">{{ metrics_data.support }}</td>
                                <td class="px-6 py-4 text-center"><span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-orange-100 text-orange-800">{{ "%.4f"|format(metrics_data.auc) }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- AI-Powered Diagnosis Section -->
        <section id="predict" class="relative" style="z-index: 9999 !important;">
            <h2 class="text-3xl font-bold mb-8 text-gray-800 flex items-center gap-2">
                <i class="fas fa-magic text-purple-600"></i>
                AI-Powered Diagnosis
            </h2>

            <!-- Row 1: Upload, Diagnosis Result (WITH CIRCULAR PROGRESS), Class Probabilities -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- UPLOAD WIDGET -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="px-6 py-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-b">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-cloud-upload-alt text-blue-600"></i>
                            Upload MRI Scan
                        </h3>
                    </div>
                    <div class="p-6">
                        <form id="predictForm">
                            <div id="dropZone" class="relative border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-50 transition-all cursor-pointer" style="z-index: 10000 !important;">
                                <div id="dropZonePrompt" class="space-y-3">
                                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400"></i>
                                    <p class="text-gray-700 font-medium text-lg">Drag & drop MRI here</p>
                                    <button type="button" id="browseButton" class="inline-block px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md">
                                        <i class="fas fa-folder-open mr-2"></i>Browse Files
                                    </button>
                                    <p class="text-sm text-gray-500">Supports: JPG, PNG, DICOM</p>
                                </div>
                                <div id="dropZoneSelected" class="hidden space-y-3">
                                    <i class="fas fa-check-circle text-6xl text-green-500"></i>
                                    <p id="selectedFileName" class="text-gray-900 font-bold text-lg">File ready</p>
                                    <button type="button" id="changeFileButton" class="inline-block px-4 py-2 bg-gray-600 text-white rounded-lg text-sm hover:bg-gray-700 transition-colors">
                                        <i class="fas fa-exchange-alt mr-2"></i>Change File
                                    </button>
                                </div>
                                <input type="file" id="imageFile" accept="image/*" class="hidden" required>
                            </div>
                            <button type="submit" id="analyzeBtn" class="w-full mt-4 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold text-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-brain mr-2"></i>Analyze MRI
                            </button>
                        </form>
                    </div>
                </div>

                <!-- PRIMARY CLASSIFICATION WITH CIRCULAR PROGRESS -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="px-6 py-4 bg-gradient-to-r from-green-50 to-emerald-50 border-b">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-clipboard-check text-green-600"></i>
                            Primary Classification
                        </h3>
                    </div>
                    <div class="p-6 flex items-center justify-center min-h-[300px]">
                        <div id="diagnosisPlaceholder" class="text-center text-gray-400">
                            <i class="fas fa-stethoscope text-6xl mb-4 opacity-50"></i>
                            <p class="text-sm">Upload an MRI to see diagnosis</p>
                        </div>
                        <div id="diagnosisLoading" class="hidden text-center">
                            <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-600 border-t-transparent mb-4"></div>
                            <p class="text-gray-600 font-medium">Analyzing MRI scan...</p>
                        </div>
                        <!-- CIRCULAR PROGRESS INDICATOR -->
                        <div id="diagnosisResult" class="hidden text-center w-full">
                            <div class="flex flex-col items-center">
                                <!-- SVG Circular Progress -->
                                <div class="relative w-48 h-48 mb-4">
                                    <svg class="transform -rotate-90 w-48 h-48">
                                        <circle cx="96" cy="96" r="88" stroke="#e5e7eb" stroke-width="12" fill="none" />
                                        <circle id="progressCircle" cx="96" cy="96" r="88" stroke="url(#gradient)" stroke-width="12" fill="none" 
                                            stroke-dasharray="552.92" stroke-dashoffset="552.92" stroke-linecap="round"
                                            style="transition: stroke-dashoffset 2s ease-in-out;" />
                                        <defs>
                                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                    </svg>
                                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                                        <span id="confidencePercent" class="text-4xl font-bold text-gray-900">0%</span>
                                        <span class="text-sm text-gray-500 mt-1">Confidence</span>
                                    </div>
                                </div>
                                <!-- Class Name with Word Break -->
                                <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-4 border border-blue-200 w-full">
                                    <p class="text-gray-600 text-xs mb-1 uppercase tracking-wide">Predicted Class</p>
                                    <h2 id="predictedClass" class="text-2xl font-extrabold text-gray-900 break-words">-</h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Class Probabilities -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-chart-bar text-purple-600"></i>
                            Class Probabilities
                        </h3>
                    </div>
                    <div class="p-6">
                        <div id="probabilitiesPlaceholder" class="text-center text-gray-400 py-12">
                            <i class="fas fa-percentage text-6xl mb-4 opacity-50"></i>
                            <p class="text-sm">Probabilities will appear here</p>
                        </div>
                        <div id="probabilitiesChart" class="hidden space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Images (Uploaded, GradCAM, Heatmap) -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <!-- Uploaded Image -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 border-b">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-image text-gray-600"></i>
                            Uploaded MRI
                        </h3>
                    </div>
                    <div class="p-6 flex items-center justify-center min-h-[300px] bg-gray-50">
                        <div id="uploadedImagePlaceholder" class="text-center text-gray-400">
                            <i class="fas fa-file-image text-6xl mb-4 opacity-50"></i>
                            <p class="text-sm">Your MRI will appear here</p>
                        </div>
                        <div id="uploadedImageContainer" class="hidden w-full">
                            <img id="uploadedImage" src="" alt="Uploaded MRI" class="w-full h-auto rounded-lg border-2 border-gray-300 shadow-lg">
                        </div>
                    </div>
                </div>

                <!-- GradCAM Visualization -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="px-6 py-4 bg-gradient-to-r from-red-50 to-rose-50 border-b">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-fire text-red-600"></i>
                            GradCAM Overlay
                        </h3>
                    </div>
                    <div class="p-6 flex items-center justify-center min-h-[300px] bg-gray-50">
                        <div id="gradcamPlaceholder" class="text-center text-gray-400">
                            <i class="fas fa-eye text-6xl mb-4 opacity-50"></i>
                            <p class="text-sm">GradCAM will appear automatically</p>
                        </div>
                        <div id="gradcamLoading" class="hidden text-center">
                            <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-red-600 border-t-transparent mb-4"></div>
                            <p class="text-gray-600 font-medium">Generating XAI...</p>
                        </div>
                        <div id="gradcamContainer" class="hidden w-full">
                            <img id="gradcamImage" src="" alt="GradCAM" class="w-full h-auto rounded-lg border-2 border-gray-300 shadow-lg">
                        </div>
                    </div>
                </div>

                <!-- Attention Heatmap -->
                <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden hover:shadow-xl transition-all">
                    <div class="px-6 py-4 bg-gradient-to-r from-yellow-50 to-amber-50 border-b">
                        <h3 class="font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-fire-alt text-yellow-600"></i>
                            Attention Heatmap
                        </h3>
                    </div>
                    <div class="p-6 flex items-center justify-center min-h-[300px] bg-gray-50">
                        <div id="heatmapPlaceholder" class="text-center text-gray-400">
                            <i class="fas fa-map-marked-alt text-6xl mb-4 opacity-50"></i>
                            <p class="text-sm">Heatmap will appear automatically</p>
                        </div>
                        <div id="heatmapContainer" class="hidden w-full">
                            <img id="heatmapImage" src="" alt="Attention Heatmap" class="w-full h-auto rounded-lg border-2 border-gray-300 shadow-lg">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alternative Class Selection -->
            <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-orange-50 to-yellow-100 border-b">
                    <h3 class="font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-orange-600"></i>
                        Alternative Class XAI Analysis <span class="text-sm font-normal text-gray-500 ml-2">(Optional)</span>
                    </h3>
                </div>
                <div class="p-6">
                    <div id="xaiClassPlaceholder" class="text-center text-gray-400 py-6">
                        <p class="text-sm">Analyze MRI to enable alternative class selection</p>
                    </div>
                    <div id="xaiClassSelector" class="hidden">
                        <p class="text-gray-600 text-sm mb-4">Want to see XAI for a different class? Select below:</p>
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                            <button class="xai-class-btn px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-bold hover:shadow-lg transition-all" data-class-idx="0">
                                <i class="fas fa-brain mr-2"></i>Mild
                            </button>
                            <button class="xai-class-btn px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg transition-all" data-class-idx="1">
                                <i class="fas fa-brain mr-2"></i>Moderate
                            </button>
                            <button class="xai-class-btn px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-bold hover:shadow-lg transition-all" data-class-idx="2">
                                <i class="fas fa-brain mr-2"></i>Non-Demented
                            </button>
                            <button class="xai-class-btn px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white rounded-xl font-bold hover:shadow-lg transition-all" data-class-idx="3">
                                <i class="fas fa-brain mr-2"></i>Very Mild
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<style>
/* CRITICAL: Force clickability */
#dropZone {
    position: relative !important;
    z-index: 10000 !important;
    cursor: pointer !important;
    pointer-events: auto !important;
}

#dropZone * {
    pointer-events: auto !important;
}

#predict {
    position: relative !important;
    z-index: 9999 !important;
}

/* Smooth animations */
.transition-all {
    transition: all 0.3s ease;
}

.hover\:shadow-xl:hover {
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}
</style>

<script>
// Global variables
let selectedFile = null;
let uploadedImageData = null;
let predictedClassIdx = null;
const classNames = ['MildDemented', 'ModerateDemented', 'NonDemented', 'VeryMildDemented'];

// Get DOM elements
const dropZone = document.getElementById('dropZone');
const dropZonePrompt = document.getElementById('dropZonePrompt');
const dropZoneSelected = document.getElementById('dropZoneSelected');
const selectedFileNameEl = document.getElementById('selectedFileName');
const fileInput = document.getElementById('imageFile');
const predictForm = document.getElementById('predictForm');
const analyzeBtn = document.getElementById('analyzeBtn');
const browseButton = document.getElementById('browseButton');
const changeFileButton = document.getElementById('changeFileButton');

console.log('ðŸš€ Professional Upload Widget Initialized');

// BROWSE BUTTON CLICK
browseButton.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('âœ… Browse button clicked');
    fileInput.value = '';
    fileInput.click();
});

// CHANGE FILE BUTTON
changeFileButton.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('âœ… Change file button clicked');
    fileInput.value = '';
    fileInput.click();
});

// DROPZONE CLICK (Backup)
dropZone.addEventListener('click', function(e) {
    if (e.target.id !== 'browseButton' && e.target.id !== 'changeFileButton') {
        console.log('âœ… Dropzone clicked');
        fileInput.click();
    }
});

// File input change
fileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        console.log('ðŸ“ File selected:', file.name);
        selectedFile = file;
        analyzeBtn.disabled = false;
        
        dropZonePrompt.classList.add('hidden');
        dropZoneSelected.classList.remove('hidden');
        selectedFileNameEl.textContent = file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name;
        dropZone.classList.add('border-green-500', 'bg-green-50');
        dropZone.classList.remove('border-gray-300');
    }
});

// Drag and drop
dropZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropZone.classList.add('border-blue-500', 'bg-blue-100');
});

dropZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-100');
});

dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-100');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        const dt = new DataTransfer();
        dt.items.add(files[0]);
        fileInput.files = dt.files;
        fileInput.dispatchEvent(new Event('change'));
    }
});

// Form submission
predictForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (!selectedFile) {
        alert('Please select a file first');
        return;
    }

    console.log('ðŸ” Starting prediction...');

    // Show loading
    document.getElementById('diagnosisPlaceholder').classList.add('hidden');
    document.getElementById('diagnosisResult').classList.add('hidden');
    document.getElementById('diagnosisLoading').classList.remove('hidden');
    document.getElementById('probabilitiesPlaceholder').classList.add('hidden');
    document.getElementById('probabilitiesChart').classList.add('hidden');

    const formData = new FormData();
    formData.append('file', selectedFile);

    try {
        const response = await fetch('/predict', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            console.log('âœ… Prediction successful:', data);
            console.log('Raw confidence from backend:', data.confidence);
            
            // Hide loading, show results
            document.getElementById('diagnosisLoading').classList.add('hidden');
            document.getElementById('diagnosisResult').classList.remove('hidden');
            
            // Update class name with WORD BREAK for long names
            document.getElementById('predictedClass').textContent = data.class_name;
            
            // FIXED: Parse confidence correctly
            // Backend returns "100.00" as a string, not 1.00
            let confidenceValue = parseFloat(data.confidence) * 100;
            console.log('Parsed confidence value:', confidenceValue);   
            
            // Ensure it's a percentage (0-100 range)
            const confidenceFormatted = confidenceValue.toFixed(2);
            
            // ANIMATE CIRCULAR PROGRESS
            const progressCircle = document.getElementById('progressCircle');
            const confidenceDisplay = document.getElementById('confidencePercent');
            
            // Calculate stroke-dashoffset (552.92 = full circle circumference)
            const circumference = 552.92;
            const offset = circumference - (circumference * confidenceValue / 100);
            
            console.log('Circle animation:', {
                value: confidenceValue,
                circumference: circumference,
                offset: offset
            });
            
            // Animate from 0 to target
            setTimeout(() => {
                progressCircle.style.strokeDashoffset = offset;
                animateValue(confidenceDisplay, 0, confidenceValue, 2000);
            }, 100);
            
            // Find predicted class index
            predictedClassIdx = classNames.indexOf(data.class_name);
            
            // Update probabilities
            renderProbabilities(data.probabilities);
            
            // Store uploaded image
            uploadedImageData = data.image;
            
            // Show uploaded image
            document.getElementById('uploadedImagePlaceholder').classList.add('hidden');
            document.getElementById('uploadedImageContainer').classList.remove('hidden');
            document.getElementById('uploadedImage').src = data.image;
            
            // AUTO-GENERATE XAI
            console.log('ðŸŽ¨ Auto-generating XAI for predicted class:', data.class_name);
            generateXAI(predictedClassIdx);
            
            // Enable alternative class selector
            document.getElementById('xaiClassPlaceholder').classList.add('hidden');
            document.getElementById('xaiClassSelector').classList.remove('hidden');
        } else {
            throw new Error(data.error || 'Prediction failed');
        }
    } catch (error) {
        console.error('âŒ Error:', error);
        alert('Error: ' + error.message);
        document.getElementById('diagnosisLoading').classList.add('hidden');
        document.getElementById('diagnosisPlaceholder').classList.remove('hidden');
        document.getElementById('probabilitiesPlaceholder').classList.remove('hidden');
    }
});

// Animate number from start to end
function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        element.textContent = (progress * (end - start) + start).toFixed(2) + '%';
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    window.requestAnimationFrame(step);
}

// Render probabilities
function renderProbabilities(probabilities) {
    const container = document.getElementById('probabilitiesChart');
    container.innerHTML = '';
    
    Object.entries(probabilities).forEach(([className, probability]) => {
        const percentage = (probability * 100).toFixed(2);
        
        const barContainer = document.createElement('div');
        barContainer.className = 'mb-3';
        
        barContainer.innerHTML = `
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-semibold text-gray-700">${className}</span>
                <span class="text-sm font-bold text-gray-900">${percentage}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                <div class="h-3 rounded-full transition-all duration-700 ease-out bg-gradient-to-r from-blue-500 to-purple-600" style="width: ${percentage}%"></div>
            </div>
        `;
        
        container.appendChild(barContainer);
    });
    
    container.classList.remove('hidden');
}

// AUTO-GENERATE XAI
async function generateXAI(classIdx) {
    if (!selectedFile) return;
    
    console.log('ðŸŽ¨ Generating XAI for class index:', classIdx);
    
    document.getElementById('gradcamPlaceholder').classList.add('hidden');
    document.getElementById('gradcamContainer').classList.add('hidden');
    document.getElementById('heatmapPlaceholder').classList.add('hidden');
    document.getElementById('heatmapContainer').classList.add('hidden');
    document.getElementById('gradcamLoading').classList.remove('hidden');

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('class_idx', classIdx);

    try {
        const response = await fetch('/api/gradcam', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            console.log('âœ… XAI generated successfully');
            
            document.getElementById('gradcamLoading').classList.add('hidden');
            document.getElementById('gradcamContainer').classList.remove('hidden');
            document.getElementById('gradcamImage').src = data.overlay;
            document.getElementById('heatmapContainer').classList.remove('hidden');
            document.getElementById('heatmapImage').src = data.heatmap;
        } else {
            throw new Error(data.error || 'XAI generation failed');
        }
    } catch (error) {
        console.error('âŒ XAI Error:', error);
        document.getElementById('gradcamLoading').classList.add('hidden');
        document.getElementById('gradcamPlaceholder').classList.remove('hidden');
        document.getElementById('heatmapPlaceholder').classList.remove('hidden');
    }
}

// Alternative class selection
document.querySelectorAll('.xai-class-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!selectedFile) {
            alert('Please upload and analyze an image first');
            return;
        }

        const classIdx = parseInt(this.dataset.classIdx);
        console.log('ðŸ”„ Generating XAI for alternative class:', classNames[classIdx]);
        generateXAI(classIdx);
    });
});

console.log('âœ… All event handlers registered. Upload widget is READY!');
</script>

{% endblock %}
