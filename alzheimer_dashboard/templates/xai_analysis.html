{% extends "base.html" %}

{% block content %}
<div class="main-content">
    <!-- Hero Section -->
    <div class="gradient-header text-white py-12 px-4">
        <div class="max-w-7xl mx-auto text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                <i class="fas fa-microscope mr-3"></i>Explainable AI Analysis
            </h1>
            <p class="text-xl text-gray-100">GradCAM Visualization & Model Interpretability</p>
        </div>
    </div>

    <!-- Info Banner -->
    <section class="max-w-7xl mx-auto px-4 py-8">
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-l-4 border-blue-500 rounded-lg p-6 shadow-md">
            <div class="flex items-start gap-4">
                <div class="bg-blue-500 text-white rounded-full w-12 h-12 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-info-circle text-xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-2">About GradCAM Technology</h3>
                    <p class="text-gray-700 leading-relaxed">
                        Upload an MRI scan to visualize which brain regions influence the model's predictions. 
                        The heatmap highlights areas of high importance, with <span class="font-semibold text-red-600">warmer colors (red/yellow)</span> 
                        indicating regions that strongly contributed to the classification decision.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Analysis Section -->
    <section class="max-w-7xl mx-auto px-4 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- LEFT COLUMN: Upload Section -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-gray-800">Upload MRI Scan</h3>
                            <p class="text-sm text-gray-600">Select brain scan image</p>
                        </div>
                    </div>
                    
                    <form id="gradcamForm">
                        <!-- Professional Drag & Drop Zone -->
                        <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all mb-4" id="dropZone">
                            <div class="flex flex-col items-center gap-3">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-file-medical text-blue-600 text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-gray-700 font-semibold">Drag & drop MRI here</p>
                                    <p class="text-sm text-gray-500 mt-1">or click to browse</p>
                                </div>
                                <p class="text-xs text-gray-400">Supported: JPG, PNG, DICOM</p>
                            </div>
                            <input type="file" id="mriFile" accept="image/*" required class="hidden">
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 rounded-lg hover:shadow-xl transform hover:scale-[1.02] transition-all">
                            <i class="fas fa-magic mr-2"></i>Generate GradCAM Analysis
                        </button>
                    </form>

                    <!-- Loading State -->
                    <div id="loading" class="hidden mt-6 text-center py-8">
                        <div class="inline-block animate-spin text-blue-600 text-5xl mb-4">
                            <i class="fas fa-spinner"></i>
                        </div>
                        <p class="text-gray-700 font-semibold">Processing Scan...</p>
                        <p class="text-sm text-gray-500 mt-2">Generating attention maps</p>
                        <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full animate-pulse" style="width: 70%"></div>
                        </div>
                    </div>
                </div>

                <!-- Prediction Summary Card (Shown after analysis) -->
                <div id="predictionSummary" class="hidden bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl shadow-lg p-6 border-2 border-green-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-check-circle text-white text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800">Diagnosis Result</h3>
                    </div>
                    <div class="text-center py-4">
                        <p class="text-sm text-gray-600 mb-2">Classification</p>
                        <p id="predictionClass" class="text-3xl font-bold text-green-700 mb-3">-</p>
                        <div class="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-sm">
                            <i class="fas fa-chart-line text-green-600"></i>
                            <span class="text-sm text-gray-600">Confidence:</span>
                            <span id="predictionConfidence" class="font-bold text-green-700">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMNS: Visualization Results (2 columns) -->
            <div id="resultsContainer" class="hidden lg:col-span-2">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Original Image Card -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                        <div class="bg-gradient-to-r from-gray-700 to-gray-800 px-6 py-4">
                            <div class="flex items-center gap-2 text-white">
                                <i class="fas fa-image text-lg"></i>
                                <h4 class="font-bold">Original MRI Scan</h4>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="relative rounded-lg overflow-hidden bg-gray-900 aspect-square flex items-center justify-center">
                                <img id="originalImage" src="" alt="Original" class="w-full h-full object-contain">
                            </div>
                            <div class="mt-4 flex items-center justify-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-info-circle"></i>
                                <span>Input scan for analysis</span>
                            </div>
                        </div>
                    </div>

                    <!-- Heatmap Card -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                        <div class="bg-gradient-to-r from-orange-500 to-red-500 px-6 py-4">
                            <div class="flex items-center gap-2 text-white">
                                <i class="fas fa-fire text-lg"></i>
                                <h4 class="font-bold">Attention Heatmap</h4>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="relative rounded-lg overflow-hidden bg-gray-900 aspect-square flex items-center justify-center">
                                <img id="heatmapImage" src="" alt="Heatmap" class="w-full h-full object-contain">
                            </div>
                            <div class="mt-4 flex items-center justify-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-thermometer-half"></i>
                                <span>Heat intensity visualization</span>
                            </div>
                        </div>
                    </div>

                    <!-- Overlay Card -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
                        <div class="bg-gradient-to-r from-purple-500 to-indigo-600 px-6 py-4">
                            <div class="flex items-center gap-2 text-white">
                                <i class="fas fa-layer-group text-lg"></i>
                                <h4 class="font-bold">GradCAM Overlay</h4>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="relative rounded-lg overflow-hidden bg-gray-900 aspect-square flex items-center justify-center">
                                <img id="overlayImage" src="" alt="Overlay" class="w-full h-full object-contain">
                            </div>
                            <div class="mt-4 flex items-center justify-center gap-2 text-sm text-gray-600">
                                <i class="fas fa-eye"></i>
                                <span>Combined visualization</span>
                            </div>
                        </div>
                    </div>

                    <!-- Interpretation Guide -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-lg p-6 border border-blue-200">
                        <div class="flex items-center gap-2 mb-4">
                            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book-medical text-white"></i>
                            </div>
                            <h4 class="font-bold text-gray-800">Interpretation Guide</h4>
                        </div>
                        <div class="space-y-3 text-sm text-gray-700">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-red-500 rounded flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-circle text-white text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-red-700">Red Regions</p>
                                    <p class="text-gray-600">Highest attention - critical for diagnosis</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-yellow-400 rounded flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-circle text-white text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-yellow-700">Yellow Regions</p>
                                    <p class="text-gray-600">Moderate importance areas</p>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 bg-blue-500 rounded flex items-center justify-center flex-shrink-0 mt-1">
                                    <i class="fas fa-circle text-white text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-semibold text-blue-700">Blue Regions</p>
                                    <p class="text-gray-600">Low attention - minimal influence</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
/* Smooth transitions for all interactive elements */
.hover\:scale-\[1\.02\]:hover {
    transform: scale(1.02);
}

/* Enhanced drop zone animations */
#dropZone {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#dropZone:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(59, 130, 246, 0.1);
}

/* Image loading animation */
#originalImage, #heatmapImage, #overlayImage {
    transition: opacity 0.3s ease-in-out;
}

/* Aspect ratio for images */
.aspect-square {
    aspect-ratio: 1 / 1;
}

/* Smooth reveal animation */
@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#resultsContainer > div {
    animation: slideUp 0.5s ease-out;
}
</style>

<script>
// Drag & Drop Setup
const dropZone = document.getElementById('dropZone');
const mriFile = document.getElementById('mriFile');

dropZone.addEventListener('click', () => mriFile.click());

dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    if (e.dataTransfer.files.length) {
        mriFile.files = e.dataTransfer.files;
        document.getElementById('gradcamForm').dispatchEvent(new Event('submit'));
    }
});

mriFile.addEventListener('change', () => {
    if (mriFile.files.length) {
        const fileName = mriFile.files[0].name;
        dropZone.querySelector('p').textContent = `Selected: ${fileName}`;
    }
});

// Form Submission
document.getElementById('gradcamForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!mriFile.files.length) {
        showNotification('Please select an MRI scan', 'error');
        return;
    }
    
    const file = mriFile.files[0];
    const formData = new FormData();
    formData.append('file', file);
    formData.append('class_idx', 0); // Default to first class

    // Show loading state
    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('resultsContainer').classList.add('hidden');
    document.getElementById('predictionSummary').classList.add('hidden');

    try {
        const response = await fetch('/api/gradcam', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            // Populate images with fade-in effect
            const originalImg = document.getElementById('originalImage');
            const heatmapImg = document.getElementById('heatmapImage');
            const overlayImg = document.getElementById('overlayImage');
            
            originalImg.style.opacity = '0';
            heatmapImg.style.opacity = '0';
            overlayImg.style.opacity = '0';
            
            originalImg.src = data.original;
            heatmapImg.src = data.heatmap;
            overlayImg.src = data.overlay;
            
            // Fade in images once loaded
            originalImg.onload = () => originalImg.style.opacity = '1';
            heatmapImg.onload = () => heatmapImg.style.opacity = '1';
            overlayImg.onload = () => overlayImg.style.opacity = '1';
            
            // Update prediction details
            document.getElementById('predictionClass').textContent = data.class_name;
            document.getElementById('predictionConfidence').textContent = 
                (data.confidence * 100).toFixed(2) + '%';
            
            // Show results with animation
            setTimeout(() => {
                document.getElementById('resultsContainer').classList.remove('hidden');
                document.getElementById('predictionSummary').classList.remove('hidden');
            }, 300);
            
            showNotification('GradCAM analysis completed successfully!', 'success');
        } else {
            showNotification('Error: ' + data.error, 'error');
        }
    } catch (error) {
        showNotification('Error generating GradCAM: ' + error.message, 'error');
    } finally {
        document.getElementById('loading').classList.add('hidden');
    }
});

// Notification Helper
function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
